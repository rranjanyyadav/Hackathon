<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Login & Sign Up Form</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="container" id="container">
        <div class="form-container sign-in">
            <form id="signInForm">
                <h1>Sign In</h1>
                <div class="social-icons">
                    <a href="#" class="icon"><i class="fa-brands fa-google"></i></a>
                    <a href="#" class="icon"><i class="fa-brands fa-facebook-f"></i></a>
                    <a href="#" class="icon"><i class="fa-brands fa-github"></i></a>
                    <a href="#" class="icon"><i class="fa-brands fa-linkedin-in"></i></a>
                </div>
                <span>or use your email account</span>
                <input type="email" placeholder="Email" required>
                <input type="password" placeholder="Password" required>
                <a href="#">Forget Your Password?</a>
                <button type="submit">Sign In</button>
                <div id="signInError" class="error-message"></div>
            </form>
        </div>

        <div class="form-container sign-up">
            <form id="signUpForm">
                <div class="back-arrow" id="back-arrow">
                     <i class="fas fa-arrow-left"></i>
                </div>

                <h1>Create Account</h1>
                
                <div class="role-selection-container">
                    <p>Select your role:</p>
                    <div class="role-options">
                        <div class="role-option" data-role="customer">
                            <span class="role-icon">üë§</span>
                            <span class="role-text">Customer</span>
                        </div>
                        <div class="role-option" data-role="vendor">
                            <span class="role-icon">üè™</span>
                            <span class="role-text">Vendor</span>
                        </div>
                        <div class="role-option" data-role="admin">
                            <span class="role-icon">‚öôÔ∏è</span>
                            <span class="role-text">Admin</span>
                        </div>
                    </div>
                </div>

                <div class="hidden-section" id="registration-details">
                    <input type="text" placeholder="Name" required>
                    <input type="email" id="email-input" placeholder="Email" required>
                    <input type="tel" id="phone-input" placeholder="Phone (optional)">
                    <input type="password" id="password-input" placeholder="Password" required>
                    
                    <div class="g-recaptcha" data-sitekey="your-site-key"></div>
                    
                    <button type="submit">Continue</button>
                </div>

                <div class="hidden-section" id="otp-verification-section">
                    <p>Verification is simulated. Click "Create Account" to proceed.</p>
                    <button type="button" id="create-account-btn">Create Account</button>
                </div>

                <div id="form-error" class="error-message"></div>
            </form>
        </div>

        <div class="toggle-container">
            <div class="toggle">
                <div class="toggle-panel toggle-left">
                    <h1>Welcome Back!</h1>
                    <p>Enter your personal details to use all of site features</p>
                    <button class="hidden" id="login">Sign In</button>
                </div>
                <div class="toggle-panel toggle-right">
                    <h1>Hello, Friend!</h1>
                    <p>Register with your personal details to use all of site features</p>
                    <button class="hidden" id="register">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
      // Import functions from the Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, 
        createUserWithEmailAndPassword, 
        signInWithEmailAndPassword 
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        setDoc 
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- Your web app's Firebase configuration ---
      const firebaseConfig = {
        apiKey: "AIzaSyCa37b-LuakNl2TwsZQES2-p_DgGgIJEuA",
        authDomain: "login-db9bb.firebaseapp.com",
        projectId: "login-db9bb",
        storageBucket: "login-db9bb.firebasestorage.app",
        messagingSenderId: "132451184061",
        appId: "1:132451184061:web:972c781b670cdff773f6d4"
      };

      // --- Initialize Firebase ---
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- Get DOM Elements (from your original script.js) ---
      const container = document.getElementById('container');
      const registerBtn = document.getElementById('register');
      const loginBtn = document.getElementById('login');
      const signUpForm = document.getElementById('signUpForm');
      const signInForm = document.getElementById('signInForm');
      const roleSelectionContainer = document.querySelector('.role-selection-container');
      const registrationDetails = document.getElementById('registration-details');
      const otpVerificationSection = document.getElementById('otp-verification-section');
      const roleOptions = document.querySelectorAll('.role-option');
      const backArrow = document.getElementById('back-arrow');
      const emailInput = document.getElementById('email-input');
      const phoneInput = document.getElementById('phone-input');
      const passwordInput = document.getElementById('password-input');
      const createAccountBtn = document.getElementById('create-account-btn');
      const formError = document.getElementById('form-error');
      const signInError = document.getElementById('signInError');

      // --- State Variables ---
      let selectedRole = null;

      // --- Function to show a specific step in the sign-up form ---
      const showStep = (step) => {
        roleSelectionContainer.classList.add('hidden-section');
        registrationDetails.classList.add('hidden-section');
        otpVerificationSection.classList.add('hidden-section');
        backArrow.classList.remove('visible');
        
        // Default height is not expanded
        container.classList.remove('expanded');

        if (step === 'roles') {
            roleSelectionContainer.classList.remove('hidden-section');
        } else if (step === 'details') {
            registrationDetails.classList.remove('hidden-section');
            backArrow.classList.add('visible');
            container.classList.add('expanded');
        } else if (step === 'otp') {
            otpVerificationSection.classList.remove('hidden-section');
            backArrow.classList.add('visible');
            container.classList.add('expanded');
        }
      };

      // --- Function to reset the sign-up form ---
      const resetSignUpForm = () => {
        signUpForm.reset();
        formError.textContent = '';
        roleOptions.forEach(opt => opt.classList.remove('selected'));
        selectedRole = null;
        if (typeof grecaptcha !== 'undefined') {
            try { grecaptcha.reset(); } catch (e) { console.log('reCAPTCHA reset failed:', e); }
        }
        // This class controls the smaller banner on mobile
        container.classList.remove('form-active'); 
        showStep('roles');
      };

      // --- Initial Setup ---
      resetSignUpForm();

      // --- Event Listeners for panel toggle ---
      registerBtn.addEventListener('click', () => {
        container.classList.add("active");
        resetSignUpForm();
      });

      loginBtn.addEventListener('click', () => {
        container.classList.remove("active");
        // Also remove the form-active class when switching back to login
        container.classList.remove("form-active"); 
        resetSignUpForm();
      });

      // --- Handle Role Selection ---
      roleOptions.forEach(option => {
        option.addEventListener('click', () => {
            roleOptions.forEach(opt => opt.classList.remove('selected'));
            option.classList.add('selected');
            selectedRole = option.getAttribute('data-role');
            // Add class to trigger CSS for smaller banner on mobile
            container.classList.add('form-active');
            setTimeout(() => showStep('details'), 200);
        });
      });

      // --- Handle Sign-Up Form Submission (Step 1: Details) ---
      signUpForm.addEventListener('submit', (event) => {
        event.preventDefault();
        formError.textContent = '';

        if (!selectedRole) {
            formError.textContent = 'Please select a role.';
            return;
        }
        if (passwordInput.value.length < 6) {
            formError.textContent = 'Password must be at least 6 characters long.';
            return;
        }
        
        showStep('otp');
      });
      
      // --- Handle Final Account Creation ---
      createAccountBtn.addEventListener('click', async () => {
          formError.textContent = '';
          const name = signUpForm.querySelector('input[type="text"]').value;
          const email = emailInput.value;
          const password = passwordInput.value;
          const phone = phoneInput.value;

          if (!name || !email || !password || !selectedRole) {
              formError.textContent = 'Please fill all required fields.';
              return;
          }

          try {
              const userCredential = await createUserWithEmailAndPassword(auth, email, password);
              const user = userCredential.user;

              await setDoc(doc(db, "users", user.uid), {
                  uid: user.uid,
                  name: name,
                  email: email,
                  phone: phone,
                  role: selectedRole,
                  createdAt: new Date()
              });

              alert('Account created successfully! Please sign in.');
              resetSignUpForm();
              container.classList.remove("active");

          } catch (error) {
              console.error("Error creating account:", error);
              if (error.code === 'auth/email-already-in-use') {
                  formError.textContent = 'This email address is already in use.';
              } else if (error.code === 'auth/weak-password') {
                  formError.textContent = 'The password is too weak.';
              } else {
                  formError.textContent = 'An error occurred. Please try again.';
              }
          }
      });

      // --- Handle Sign-In Form Submission ---
      signInForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        signInError.textContent = '';
        const email = signInForm.querySelector('input[type="email"]').value;
        const password = signInForm.querySelector('input[type="password"]').value;

        if (!email || !password) {
            signInError.textContent = 'Please enter both email and password.';
            return;
        }

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            console.log('Signed in successfully:', user.uid);
            alert('Sign in successful!');
            // window.location.href = '/dashboard.html';
        } catch (error) {
            console.error("Error signing in:", error);
            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                signInError.textContent = 'Invalid email or password.';
            } else {
                signInError.textContent = 'An error occurred. Please try again.';
            }
        }
      });

      // --- Handle Back Arrow Click ---
      backArrow.addEventListener('click', () => {
        // If on OTP step, go back to details
        if (otpVerificationSection.classList.contains('hidden-section') === false) {
            showStep('details');
        } 
        // If at details step, go back to roles
        else if (registrationDetails.classList.contains('hidden-section') === false) {
            // Remove the class that makes the banner small
            container.classList.remove('form-active'); 
            showStep('roles');
        }
      });

    </script>
</body>
</html>
